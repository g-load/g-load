<script>
    // ✅ Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDSiocR1RLgQwGzgBiKcr_W7NBJxQSbyH8",
        authDomain: "g-load-dc40b.firebaseapp.com",
        databaseURL: "https://g-load-dc40b-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "g-load-dc40b",
        storageBucket: "g-load-dc40b.appspot.com",
        messagingSenderId: "589491451732",
        appId: "1:589491451732:web:b36abd93b770651dfd7ac1"
    };

    // ✅ Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // ✅ Load Google Charts
    google.charts.load('current', { packages: ['corechart', 'line'] });
    google.charts.setOnLoadCallback(drawChart);

    let data, chart, options;

    function drawChart() {
        data = new google.visualization.DataTable();
        data.addColumn('datetime', 'Time (IST)');
        data.addColumn('number', 'Acceleration (g)');

        options = {
            title: 'Real-Time Acceleration Data',
            curveType: 'function',
            legend: { position: 'bottom' },
            hAxis: { title: 'Time (IST)', format: 'h:mm a' }, // ✅ 12-hour format
            vAxis: { title: 'Acceleration (g)', minValue: 0 },
            backgroundColor: '#f5f5f5'
        };

        chart = new google.visualization.LineChart(document.getElementById('chart_div'));

        fetchData(); // ✅ Start fetching data
    }

    function fetchData(selectedDate = null) {
        const ref = database.ref("/acceleration_data");

        ref.orderByKey().limitToLast(20).on('value', (snapshot) => {
            data.removeRows(0, data.getNumberOfRows());

            snapshot.forEach(childSnapshot => {
                const entry = childSnapshot.val();
                const timestampUTC = new Date(entry.timestamp * 1000); // ✅ Convert UNIX timestamp to milliseconds

                // ✅ Convert UTC to IST (Indian Standard Time)
                let timestampIST = new Date(timestampUTC.toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));

                // ✅ Format time in 12-hour AM/PM format
                let hours = timestampIST.getHours();
                let minutes = timestampIST.getMinutes();
                let ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12 || 12;
                minutes = minutes < 10 ? '0' + minutes : minutes;
                let formattedTime = ${hours}:${minutes} ${ampm};

                const acceleration = entry.acceleration_g;

                if (selectedDate) {
                    const selectedDateIST = new Date(selectedDate);
                    if (timestampIST.toDateString() !== selectedDateIST.toDateString()) {
                        return;
                    }
                }

                // ✅ Add formatted time to the graph
                data.addRow([{ v: timestampIST, f: formattedTime }, acceleration]);
                document.getElementById('acceleration').innerText = acceleration.toFixed(2) + " g";
            });

            chart.draw(data, options);
        });
    }
</script>
